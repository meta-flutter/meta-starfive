From bb378d7f85605f6bf54f126f1c8a704260dd69ea Mon Sep 17 00:00:00 2001
From: "max.ma" <max.ma@starfivetech.com>
Date: Mon, 10 Jan 2022 15:33:18 -0800
Subject: [PATCH 30/32] add multilib support for v & b

---
 gcc/common/config/riscv/riscv-common.c | 15 ++++++++---
 gcc/config/riscv/riscv.opt             |  2 ++
 gcc/config/riscv/t-elf-multilib        | 36 +++++---------------------
 3 files changed, 21 insertions(+), 32 deletions(-)

diff --git a/gcc/common/config/riscv/riscv-common.c b/gcc/common/config/riscv/riscv-common.c
index ce0664a6d08..df90695e7a6 100644
--- a/gcc/common/config/riscv/riscv-common.c
+++ b/gcc/common/config/riscv/riscv-common.c
@@ -105,6 +105,7 @@ static const struct riscv_ext_version riscv_ext_version_table[] =
   {"zifencei", ISA_SPEC_CLASS_20191213, 2, 0},
   {"zifencei", ISA_SPEC_CLASS_20190608, 2, 0},
 
+  {"b", ISA_SPEC_CLASS_NONE, 1, 0},
   {"zba", ISA_SPEC_CLASS_NONE, 1, 0},
   {"zbb", ISA_SPEC_CLASS_NONE, 1, 0},
   {"zbc", ISA_SPEC_CLASS_NONE, 1, 0},
@@ -596,6 +597,7 @@ riscv_subset_list::parse_std_ext (const char *p)
   char std_ext = '\0';
   bool explicit_version_p = false;
 
+
   /* First letter must start with i, e or g.  */
   switch (*p)
     {
@@ -642,7 +644,6 @@ riscv_subset_list::parse_std_ext (const char *p)
       add ("d", false);
       add ("zicsr", true);
       add ("zifencei", true);
-
       break;
 
     default:
@@ -689,8 +690,15 @@ riscv_subset_list::parse_std_ext (const char *p)
 
       p = parsing_subset_version (subset, p, &major_version, &minor_version,
 				  /* std_ext_p= */ true, &explicit_version_p);
-
-      add (subset, major_version, minor_version, explicit_version_p, false);
+      if (std_ext == 'b')
+  { 
+    add ("zba", major_version, minor_version, explicit_version_p, false);
+    add ("zbb", major_version, minor_version, explicit_version_p, false);
+    add ("zbc", major_version, minor_version, explicit_version_p, false);
+    add ("zbs", major_version, minor_version, explicit_version_p, false);
+  }
+      else 
+  add (subset, major_version, minor_version, explicit_version_p, false);
     }
   return p;
 }
@@ -913,6 +921,7 @@ static const riscv_ext_flag_table_t riscv_ext_flag_table[] =
   {"zicsr",    &gcc_options::x_riscv_zi_subext, MASK_ZICSR},
   {"zifencei", &gcc_options::x_riscv_zi_subext, MASK_ZIFENCEI},
 
+  {"b", &gcc_options::x_target_flags, MASK_BITMANIP},
   {"zba", &gcc_options::x_riscv_zb_subext, MASK_ZBA},
   {"zbb", &gcc_options::x_riscv_zb_subext, MASK_ZBB},
   {"zbs", &gcc_options::x_riscv_zb_subext, MASK_ZBS},
diff --git a/gcc/config/riscv/riscv.opt b/gcc/config/riscv/riscv.opt
index 3b7d5b591e6..a271b211a1a 100644
--- a/gcc/config/riscv/riscv.opt
+++ b/gcc/config/riscv/riscv.opt
@@ -136,6 +136,8 @@ Mask(64BIT)
 
 Mask(MUL)
 
+Mask(BITMANIP)
+
 Mask(ATOMIC)
 
 Mask(HARD_FLOAT)
diff --git a/gcc/config/riscv/t-elf-multilib b/gcc/config/riscv/t-elf-multilib
index 19f9434616c..4e40c4f6cea 100644
--- a/gcc/config/riscv/t-elf-multilib
+++ b/gcc/config/riscv/t-elf-multilib
@@ -1,30 +1,8 @@
 # This file was generated by multilib-generator with the command:
-#  ./multilib-generator rv32i-ilp32--c rv32im-ilp32--c rv32iac-ilp32-- rv32imac-ilp32-- rv32imafc-ilp32f-rv32imafdc- rv64imac-lp64-- rv64imafdc-lp64d--
-MULTILIB_OPTIONS = march=rv32i/march=rv32ic/march=rv32im/march=rv32imc/march=rv32iac/march=rv32imac/march=rv32imafc/march=rv32imafdc/march=rv32gc/march=rv64imac/march=rv64imafdc/march=rv64gc mabi=ilp32/mabi=ilp32f/mabi=lp64/mabi=lp64d
-MULTILIB_DIRNAMES = rv32i \
-rv32ic \
-rv32im \
-rv32imc \
-rv32iac \
-rv32imac \
-rv32imafc \
-rv32imafdc \
-rv32gc \
-rv64imac \
-rv64imafdc \
-rv64gc ilp32 \
-ilp32f \
-lp64 \
-lp64d
-MULTILIB_REQUIRED = march=rv32i/mabi=ilp32 \
-march=rv32im/mabi=ilp32 \
-march=rv32iac/mabi=ilp32 \
-march=rv32imac/mabi=ilp32 \
-march=rv32imafc/mabi=ilp32f \
-march=rv64imac/mabi=lp64 \
-march=rv64imafdc/mabi=lp64d
-MULTILIB_REUSE = march.rv32i/mabi.ilp32=march.rv32ic/mabi.ilp32 \
-march.rv32im/mabi.ilp32=march.rv32imc/mabi.ilp32 \
-march.rv32imafc/mabi.ilp32f=march.rv32imafdc/mabi.ilp32f \
-march.rv32imafc/mabi.ilp32f=march.rv32gc/mabi.ilp32f \
-march.rv64imafdc/mabi.lp64d=march.rv64gc/mabi.lp64d
+#  ./riscv-gcc/gcc/config/riscv/multilib-generator rv64imafdcv_zba_zbb_zbc_zbs-lp64d-- rv64imafdc_zba_zbb_zbc_zbs-lp64d--
+MULTILIB_OPTIONS = march=rv64imafdcv_zba_zbb_zbc_zbs/march=rv64imafdc_zba_zbb_zbc_zbs mabi=lp64d
+MULTILIB_DIRNAMES = rv64imafdcv_zba_zbb_zbc_zbs \
+rv64imafdc_zba_zbb_zbc_zbs lp64d
+MULTILIB_REQUIRED = march=rv64imafdcv_zba_zbb_zbc_zbs/mabi=lp64d \
+march=rv64imafdc_zba_zbb_zbc_zbs/mabi=lp64d
+MULTILIB_REUSE = 
-- 
2.33.1

