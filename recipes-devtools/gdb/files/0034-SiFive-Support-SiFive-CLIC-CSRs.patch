From c85da1a9c3aaf77bc803e06404594d6f38845da3 Mon Sep 17 00:00:00 2001
From: Jim Wilson <jimw@sifive.com>
Date: Thu, 21 Feb 2019 19:21:23 -0800
Subject: [PATCH 34/48] SiFive: Support SiFive CLIC CSRs.

---
 gas/config/tc-riscv.c                            | 1 +
 gas/testsuite/gas/riscv/priv-reg-version-1p10.d  | 4 ++++
 gas/testsuite/gas/riscv/priv-reg-version-1p11.d  | 4 ++++
 gas/testsuite/gas/riscv/priv-reg-version-1p9p1.d | 4 ++++
 gas/testsuite/gas/riscv/priv-reg.s               | 6 ++++++
 include/opcode/riscv-opc.h                       | 8 ++++++++
 include/opcode/riscv.h                           | 3 ++-
 7 files changed, 29 insertions(+), 1 deletion(-)

diff --git a/gas/config/tc-riscv.c b/gas/config/tc-riscv.c
index 57d2908fcd..44e9358dd7 100644
--- a/gas/config/tc-riscv.c
+++ b/gas/config/tc-riscv.c
@@ -729,6 +729,7 @@ riscv_csr_address (const char *csr_name,
       need_check_version = FALSE;
       break;
     case CSR_CLASS_DEBUG:
+    case CSR_CLASS_CLIC:
       need_check_version = FALSE;
       break;
     default:
diff --git a/gas/testsuite/gas/riscv/priv-reg-version-1p10.d b/gas/testsuite/gas/riscv/priv-reg-version-1p10.d
index 0a023ea5a2..2db8d2021e 100644
--- a/gas/testsuite/gas/riscv/priv-reg-version-1p10.d
+++ b/gas/testsuite/gas/riscv/priv-reg-version-1p10.d
@@ -272,3 +272,7 @@ Disassembly of section .text:
 [     	]+[0-9a-f]+:[  	]+7a102573[    	]+csrr[        	]+a0,tdata1
 [     	]+[0-9a-f]+:[  	]+7a302573[    	]+csrr[        	]+a0,tdata3
 [     	]+[0-9a-f]+:[  	]+7a302573[    	]+csrr[        	]+a0,tdata3
+[     	]+[0-9a-f]+:[  	]+30702573[    	]+csrr[        	]+a0,mtvt
+[     	]+[0-9a-f]+:[  	]+34502573[    	]+csrr[        	]+a0,mnxti
+[     	]+[0-9a-f]+:[  	]+34602573[    	]+csrr[        	]+a0,mintstatus
+[     	]+[0-9a-f]+:[  	]+34811173[    	]+csrrw[        	]+sp,mscratchcsw,sp
diff --git a/gas/testsuite/gas/riscv/priv-reg-version-1p11.d b/gas/testsuite/gas/riscv/priv-reg-version-1p11.d
index 5956b0d9fd..77ed98891c 100644
--- a/gas/testsuite/gas/riscv/priv-reg-version-1p11.d
+++ b/gas/testsuite/gas/riscv/priv-reg-version-1p11.d
@@ -272,3 +272,7 @@ Disassembly of section .text:
 [     	]+[0-9a-f]+:[  	]+7a102573[    	]+csrr[        	]+a0,tdata1
 [     	]+[0-9a-f]+:[  	]+7a302573[    	]+csrr[        	]+a0,tdata3
 [     	]+[0-9a-f]+:[  	]+7a302573[    	]+csrr[        	]+a0,tdata3
+[     	]+[0-9a-f]+:[  	]+30702573[    	]+csrr[        	]+a0,mtvt
+[     	]+[0-9a-f]+:[  	]+34502573[    	]+csrr[        	]+a0,mnxti
+[     	]+[0-9a-f]+:[  	]+34602573[    	]+csrr[        	]+a0,mintstatus
+[     	]+[0-9a-f]+:[  	]+34811173[    	]+csrrw[        	]+sp,mscratchcsw,sp
diff --git a/gas/testsuite/gas/riscv/priv-reg-version-1p9p1.d b/gas/testsuite/gas/riscv/priv-reg-version-1p9p1.d
index 3fea56d947..7e1515f8be 100644
--- a/gas/testsuite/gas/riscv/priv-reg-version-1p9p1.d
+++ b/gas/testsuite/gas/riscv/priv-reg-version-1p9p1.d
@@ -272,3 +272,7 @@ Disassembly of section .text:
 [     	]+[0-9a-f]+:[  	]+7a102573[    	]+csrr[        	]+a0,tdata1
 [     	]+[0-9a-f]+:[  	]+7a302573[    	]+csrr[        	]+a0,tdata3
 [     	]+[0-9a-f]+:[  	]+7a302573[    	]+csrr[        	]+a0,tdata3
+[     	]+[0-9a-f]+:[  	]+30702573[    	]+csrr[        	]+a0,mtvt
+[     	]+[0-9a-f]+:[  	]+34502573[    	]+csrr[        	]+a0,mnxti
+[     	]+[0-9a-f]+:[  	]+34602573[    	]+csrr[        	]+a0,mintstatus
+[     	]+[0-9a-f]+:[  	]+34811173[    	]+csrrw[        	]+sp,mscratchcsw,sp
diff --git a/gas/testsuite/gas/riscv/priv-reg.s b/gas/testsuite/gas/riscv/priv-reg.s
index 8f625054c1..bce7d00b81 100644
--- a/gas/testsuite/gas/riscv/priv-reg.s
+++ b/gas/testsuite/gas/riscv/priv-reg.s
@@ -291,3 +291,9 @@
 	csr etrigger		# 0x7a1, alias to tdata1
 	csr textra32		# 0x7a3, alias to tdata3
 	csr textra64		# 0x7a3, alias to tdata3
+
+	# CLIC registers
+	csr mtvt
+	csr mnxti
+	csr mintstatus
+	csrrw sp,mscratchcsw,sp
diff --git a/include/opcode/riscv-opc.h b/include/opcode/riscv-opc.h
index 2355f14b73..66e3f8f652 100644
--- a/include/opcode/riscv-opc.h
+++ b/include/opcode/riscv-opc.h
@@ -3348,6 +3348,10 @@ funct6 VM  VS2  VS1/RS1/IMM funct3 VD   opcode
 #define CSR_TCONTROL 0x7a5
 #define CSR_MCONTEXT 0x7a8
 #define CSR_SCONTEXT 0x7aa
+#define CSR_MTVT 0x307
+#define CSR_MNXTI 0x345
+#define CSR_MINTSTATUS 0x346
+#define CSR_MSCRATCHCSW 0x348
 #endif /* RISCV_ENCODING_H.  */
 #ifdef DECLARE_INSN
 DECLARE_INSN(slli_rv32, MATCH_SLLI_RV32, MASK_SLLI_RV32)
@@ -3926,6 +3930,10 @@ DECLARE_CSR(tinfo, CSR_TINFO, CSR_CLASS_DEBUG, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_C
 DECLARE_CSR(tcontrol, CSR_TCONTROL, CSR_CLASS_DEBUG, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
 DECLARE_CSR(mcontext, CSR_MCONTEXT, CSR_CLASS_DEBUG, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
 DECLARE_CSR(scontext, CSR_SCONTEXT, CSR_CLASS_DEBUG, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
+DECLARE_CSR(mtvt, CSR_MTVT, CSR_CLASS_CLIC, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
+DECLARE_CSR(mnxti, CSR_MNXTI, CSR_CLASS_CLIC, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
+DECLARE_CSR(mintstatus, CSR_MINTSTATUS, CSR_CLASS_CLIC, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
+DECLARE_CSR(mscratchcsw, CSR_MSCRATCHCSW, CSR_CLASS_CLIC, PRIV_SPEC_CLASS_NONE, PRIV_SPEC_CLASS_NONE)
 #endif /* DECLARE_CSR.  */
 #ifdef DECLARE_CSR_ALIAS
 DECLARE_CSR_ALIAS(ubadaddr, CSR_UTVAL, CSR_CLASS_I, PRIV_SPEC_CLASS_1P9P1, PRIV_SPEC_CLASS_1P10)
diff --git a/include/opcode/riscv.h b/include/opcode/riscv.h
index 31bdcf95a9..2e1a665c6b 100644
--- a/include/opcode/riscv.h
+++ b/include/opcode/riscv.h
@@ -460,7 +460,8 @@ enum riscv_csr_class
   CSR_CLASS_I_32,      /* rv32 only */
   CSR_CLASS_F,         /* f-ext only */
   CSR_CLASS_V,         /* v-ext only */
-  CSR_CLASS_DEBUG      /* debug CSR */
+  CSR_CLASS_DEBUG,     /* debug CSR */
+  CSR_CLASS_CLIC       /* clic CSR */
 };
 
 /* The current supported privilege spec versions.  */
-- 
2.33.0

